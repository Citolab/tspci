<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hello RequireJS</title>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"
      integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- <link rel="stylesheet" class="bootswatcher" href="//bootswatch.com/5/lumen/bootstrap.min.css" /> -->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />

    <style>
      html {
        font-size: 100%;
      }
      #pciContainer {
        width: 100%;
        /* min-width: 800px; */
        max-width: 1024px;
        height: 600px;
        min-height: 600px;
        /* max-height: 600px; */
        border: 1px solid #eeeeee;
        overflow: hidden;
        margin: 0 auto;
        background-color: white;
        border-radius: 10px;
        margin-top: 1rem;
      }
      #devtools {
        max-width: 1024px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container">
      <iframe id="pciContainer" class="shadow-sm"> </iframe>
      <div id="devtools"></div>
    </div>

    <script type="module">
      import { h, Component, render } from "https://unpkg.com/preact@latest?module";
      import { useState, useEffect } from "https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module";
      import htm from "https://unpkg.com/htm?module";
      // Initialize htm with Preact
      const html = htm.bind(h);

      function App({ item }) {
        const [show, setShow] = useState(false);

        let keyArray = [];
        if (item.config && item.config.properties) {
          keyArray = Object.keys(item.config.properties).map((keyName, keyIndex) => ({
            key: keyName,
            value: item.config.properties[keyName],
          }));
        }

        function resetlocalstorage() {
          localStorage.removeItem(item.typeIdentifier + "_state");
          localStorage.removeItem(item.typeIdentifier + "_props");
          localStorage.removeItem(item.typeIdentifier + "_response");
        }

        function reset() {
          resetlocalstorage();
          location.reload();
        }

        function resetResponse() {
          localStorage.removeItem(item.typeIdentifier + "_response");
          item.resetResponse();
        }

        function setResponse() {
          const response = localStorage.getItem(item.typeIdentifier + "_response");
          if (response) {
            item.setResponse({
              base: {
                string: response,
              },
            });
          } else {
            alert("no response stored");
          }
        }

        function saveResponse() {
          localStorage.setItem(item.typeIdentifier + "_response", item.getResponse().base.string);
        }

        function compareResponse() {
          const response = localStorage.getItem(item.typeIdentifier + "_response");
          if (!response) {
            alert("no response stored");
            return;
          }
          if (response === item.getResponse().base.string) {
            alert("same");
          } else {
            alert("different");
          }
        }

        function reload() {
          const state = item.getState();
          localStorage.setItem(item.typeIdentifier + "_state", JSON.stringify(state));
          location.reload();
        }

        function changeConfig(key, value) {
          item.config.properties[key] = value;
          item.trigger(`change${key}`, value);
        }

        function reConfig(key, value) {
          localStorage.setItem(item.typeIdentifier + "_props", JSON.stringify(item.config.properties));
          location.reload();
        }

        function unload() {
          item.destroy && item.destroy();
          item.oncompleted && item.oncompleted();
          var name = require.undef("index.js");
          loadItem();
        }

        return html`
          <div>
            <div style="width:300px" class="shadow offcanvas offcanvas-end ${show ? "show visible" : ""}">
              <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasExampleLabel">properties</h5>
                <button
                  type="button"
                  onClick="${() => setShow(false)}"
                  disabled="${!item.config}"
                  class="btn-close text-reset"
                ></button>
              </div>
              <div class="offcanvas-body">
                <ul class="card-body">
                  ${keyArray.map(
                    ({ key, value }) => html`<div>
                      <div>${key}</div>
                      <input
                        type="text"
                        class="form-control"
                        value="${value}"
                        onkeyup="${(e) => changeConfig(key, e.target.value)}"
                      />
                    </div>`
                  )}
                </ul>
                <button class="btn btn-primary" onClick="${() => reConfig()}">save and reload</button>
              </div>
            </div>

            <div class="d-flex justify-content-start mt-3" role="toolbar" aria-label="Toolbar with button groups">
              <div>
                <small class="text-muted">configuration</small>
                <div class="btn-group me-2 shadow-sm" role="group" aria-label="Basic checkbox toggle button group">
                  <button class="btn btn-outline-secondary" onClick="${() => setShow(true)}">props</button>
                  <button
                    class="btn btn-outline-secondary"
                    onClick="${() => alert(JSON.stringify(item.config), null, 4)}"
                  >
                    config
                  </button>
                </div>
              </div>

              <div>
                <small class="text-muted">data</small>
                <div class="btn-group me-2 shadow-sm" role="group" aria-label="Basic checkbox toggle button group">
                  <button
                    class="btn btn-outline-secondary"
                    onClick="${() => alert(JSON.stringify(item.getResponse(), null, 4))}"
                  >
                    getResponse
                  </button>
                  <button class="btn btn-outline-secondary" onClick="${() => alert(item.getState())}">getState</button>
                </div>
              </div>

              <div>
                <small class="text-muted">state</small>
                <div class="btn-group me-2 shadow-sm" role="group" aria-label="Basic checkbox toggle button group">
                  <button class="btn btn-outline-secondary" onClick="${() => reload()}">reload</button>
                </div>
              </div>
              <div>
                <small class="text-muted">responses</small>
                <div class="btn-group me-2 shadow-sm" role="group" aria-label="Basic checkbox toggle button group">
                  <button class="btn btn-outline-secondary" onClick="${() => saveResponse()}">store</button>
                  <button class="btn btn-outline-secondary" onClick="${() => compareResponse()}">compare</button>
                  <button class="btn btn-outline-secondary" onClick="${() => setResponse()}">set</button>
                  <button
                    class="btn btn-outline-secondary"
                    disabled="${!item.resetResponse}"
                    onClick="${() => resetResponse()}"
                  >
                    reset
                  </button>
                </div>
              </div>

              <div>
                <small class="text-muted">ã…¤</small>
                <div class="d-flex">
                  <button
                    class="btn bg-light shadow-sm btn-outline-danger me-2"
                    disabled="${!(item.destroy || item.oncompleted)}"
                    onClick="${() => unload()}"
                  >
                    unload
                  </button>
                  <button class="btn bg-light shadow-sm btn-outline-danger" onClick="${() => reset()}">reset</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function register(item) {
        let state = undefined;
        const localStorageState = localStorage.getItem(item.typeIdentifier + "_state");
        if (localStorageState) {
          state = JSON.parse(localStorageState);
        }
        let props = {};
        const localStorageProps = localStorage.getItem(item.typeIdentifier + "_props");
        if (localStorageProps) {
          props = JSON.parse(localStorageProps);
        }
        const dom = document.getElementById("pciContainer");
        const config = {
          onready: () => {
            document.getElementById("loading").innerHTML = "";
          },
          properties: props,
        };

        // item.getInstance(dom, config, state);

        if (item.getResponse() !== undefined) {
          document.getElementById("noresponse").style.display = "block";
        }

        localStorage.removeItem(item.typeIdentifier + "_state");
      }

      define("qtiCustomInteractionContext", (qtiCustomInteractionContext) => {
        return { register: (ctxA) => register(ctxA) };
      });

      function loadItem() {
        requirejs(["index.js"], (itemInstance) => {
          register(itemInstance);
          render(html`<${App} item="${itemInstance}" />`, document.getElementById("devtools"));
        });
      }

      window["CES"] = {
        setResponse: (data) => console.log("setting the data", data),
        getResponse: () => {
          console.log("getting the data");
          return "";
        },
      };
      var iframe = document.getElementById("pciContainer"),
        iframeWin = iframe.contentWindow || iframe,
        iframeDoc = iframe.contentDocument || iframeWin.document;

      iframe.onload = () => {
        render(html`<${App} item="${itemInstance}" />`, document.getElementById("devtools"));
      };

      iframeDoc.open();
      iframeDoc.write("\<html>\<head>\<script src='index.js'>\<\/script>\<\/head>\<body>\<\/body>\<\/html>");
      iframeDoc.close();

      // window.onload = () => loadItem();
    </script>

    <h3 style="margin-top: 12rem">checklist</h3>
    <ul style="margin-bottom: 10rem">
      <li>Is the css scoped to the item?</li>
      <li>Is the css/item somewhat responsive on smaller screens</li>
      <li>Can you reset the item to its initial state</li>
      <li>Can it restore its state ( reload )</li>
      <li>Can you change the config</li>
      <li>Colorblind</li>
      <li>Touch/Mouse friendly</li>
      <li>Works in older browser like IE11</li>
      <li>Destroys itself correctly, removing event listeners</li>
      <li>No objects or variables on global scope</li>
      <li>Triggers correctly on changed config properties</li>
      <li>Implements on off() methods of tao?</li>
      <li>Response type and response correct</li>
      <li>getResponse() should give undefined when user has not done anything</li>
      <li>For TAO to enter response is the entered comparable by the response given</li>
    </ul>
  </body>
</html>
